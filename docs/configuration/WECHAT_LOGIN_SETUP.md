# 微信登录配置指南

## 概述

TradingAgents-CN 支持微信一键登录功能，用户可以通过微信账号快速登录系统。新用户首次使用微信登录时会自动注册为普通用户。

## 前置条件

1. **微信开放平台账号**
   - 前往 [微信开放平台](https://open.weixin.qq.com/) 注册开发者账号
   - 完成企业认证（个人开发者不支持网站应用）

2. **创建网站应用**
   - 登录微信开放平台
   - 进入"管理中心" -> "网站应用"
   - 创建新的网站应用
   - 填写应用信息：
     - 应用名称
     - 应用简介
     - 应用官网（需要已备案的域名）
     - 授权回调域（需要填写实际部署的域名）

3. **获取应用凭证**
   - 创建应用后，获取 `AppID` 和 `AppSecret`
   - 妥善保管 `AppSecret`，不要泄露

## 配置步骤

### 1. 设置环境变量

在项目根目录的 `.env` 文件中添加以下配置：

```bash
# 微信登录配置
WECHAT_APP_ID=你的AppID
WECHAT_APP_SECRET=你的AppSecret
WECHAT_REDIRECT_URI=http://你的域名/wechat/callback
```

**重要说明：**
- `WECHAT_REDIRECT_URI` 必须是完整URL，且必须与微信开放平台中配置的授权回调域匹配
- 如果使用 Streamlit，回调URI应该指向你的Streamlit应用主页面
- 例如：`http://yourdomain.com:8501/?wechat_callback=true`

### 2. 配置授权回调域

在微信开放平台的应用设置中，配置"授权回调域"：
- 如果部署在 `http://localhost:8501`，则填写 `localhost:8501`
- 如果部署在 `https://yourdomain.com`，则填写 `yourdomain.com`

### 3. 重启应用

配置完成后，重启Web应用使配置生效：

```bash
python start_web.py
```

## 功能说明

### 用户注册

- 首次使用微信登录的用户会自动注册
- 用户名格式：`wechat_xxxxxxxxxxxx`（基于openid生成）
- 默认角色：`user`（普通用户）
- 默认权限：`["analysis"]`（只有分析权限）
- 默认点数：`10`点

### 用户信息存储

微信登录的用户信息包含：
- `wechat_openid`: 微信用户唯一标识
- `wechat_unionid`: 微信开放平台统一标识（可选）
- `wechat_nickname`: 微信昵称
- `wechat_headimgurl`: 微信头像URL

### 权限管理

- 微信登录注册的用户默认为普通用户
- 管理员可以在"会员管理"页面修改用户的角色和权限
- 管理员可以提升用户为管理员，或分配更多权限

## 测试微信登录

### 1. 检查配置

访问登录页面，如果看到"💬 微信一键登录"按钮，说明配置成功。

如果没有看到按钮或显示"微信登录功能未配置"，请检查：
- `.env` 文件中的配置是否正确
- 环境变量是否已加载
- 应用是否已重启

### 2. 测试登录流程

1. 点击"💬 微信一键登录"按钮
2. 跳转到微信授权页面
3. 确认授权后，会跳转回应用
4. 系统自动完成登录

## 常见问题

### Q1: 提示"微信登录未配置"

**原因：** 环境变量未设置或未正确加载

**解决方法：**
1. 检查 `.env` 文件是否存在
2. 确认环境变量名称正确（`WECHAT_APP_ID`、`WECHAT_APP_SECRET`、`WECHAT_REDIRECT_URI`）
3. 重启应用

### Q2: 授权回调失败

**原因：** 回调URI与微信开放平台配置不匹配

**解决方法：**
1. 检查 `WECHAT_REDIRECT_URI` 是否与微信开放平台中的"授权回调域"匹配
2. 确保回调URI使用 `http://` 或 `https://` 完整URL格式
3. 确保域名已备案（如果是国内服务器）

### Q3: 获取用户信息失败

**原因：** access_token过期或无效

**解决方法：**
1. 检查 `AppSecret` 是否正确
2. 检查网络连接是否正常
3. 查看应用日志获取详细错误信息

### Q4: 已存在用户重复注册

**解决：** 系统会自动识别已存在的微信用户（通过openid），不会重复注册，而是更新用户信息。

## 安全注意事项

1. **保护AppSecret**
   - 不要将 `AppSecret` 提交到版本控制系统
   - 使用 `.env` 文件管理敏感信息
   - 在生产环境中使用环境变量或密钥管理服务

2. **HTTPS要求**
   - 生产环境必须使用HTTPS
   - 微信开放平台要求回调地址使用HTTPS（本地测试除外）

3. **域名备案**
   - 国内服务器必须完成域名备案
   - 未备案的域名无法通过微信审核

## 技术实现

微信登录采用OAuth2.0网页授权流程：

1. **用户点击微信登录按钮**
   - 生成授权URL
   - 跳转到微信授权页面

2. **用户授权**
   - 微信返回授权码（code）
   - 跳转回应用回调地址

3. **获取access_token**
   - 使用授权码和AppSecret换取access_token

4. **获取用户信息**
   - 使用access_token获取用户基本信息

5. **自动注册/登录**
   - 检查用户是否存在（通过openid）
   - 不存在则自动注册
   - 存在则更新信息并登录

## 相关文件

- `web/utils/wechat_auth.py`: 微信登录工具模块
- `web/utils/auth_manager.py`: 用户认证管理器（包含微信用户注册方法）
- `web/components/login.py`: 登录界面组件（包含微信登录按钮）

## 技术支持

如遇到问题，请：
1. 查看应用日志文件
2. 检查微信开放平台应用状态
3. 联系系统管理员
